<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フルオンチェーンNFTオークション＆投票サービス</title>
    <style>
        :root{--primary-color:#6c5ce7;--secondary-color:#a29bfe;--accent-color:#fd79a8;--background-color:#f9f9f9;--card-background:#fff;--text-color:#333;--text-light:#666;--border-color:#e0e0e0;--success-color:#00b894;--warning-color:#fdcb6e;--error-color:#d63031;--shadow:0 4px 6px rgba(0,0,0,.1);--border-radius:8px}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Helvetica Neue',Arial,sans-serif;line-height:1.6;color:var(--text-color);background-color:var(--background-color)}.hidden{display:none!important}.container{max-width:1200px;margin:0 auto;padding:0 20px}.btn,.btn-secondary{display:inline-block;padding:10px 20px;border:none;border-radius:var(--border-radius);font-weight:600;cursor:pointer;transition:all .3s ease;text-align:center}.btn{background-color:var(--primary-color);color:#fff}.btn:hover{background-color:#5649c0;transform:translateY(-2px);box-shadow:var(--shadow)}.btn-secondary{background-color:var(--secondary-color);color:#fff}.btn-secondary:hover{background-color:#8b7ffd;transform:translateY(-2px);box-shadow:var(--shadow)}header{background-color:var(--card-background);padding:20px;box-shadow:var(--shadow);position:sticky;top:0;z-index:100}header h1{color:var(--primary-color);margin-bottom:10px;font-size:1.8rem}.wallet-container{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}#wallet-info{display:flex;gap:20px}#wallet-address,#wallet-balance{background-color:var(--background-color);padding:8px 12px;border-radius:var(--border-radius);font-size:.9rem}main{padding:30px 20px;max-width:1200px;margin:0 auto}.section{background-color:var(--card-background);border-radius:var(--border-radius);box-shadow:var(--shadow);padding:25px;margin-bottom:30px}.section h2{color:var(--primary-color);margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid var(--border-color)}.auction-container{display:grid;grid-template-columns:1fr 1fr;gap:30px}.nft-preview{display:flex;flex-direction:column}.nft-image-container{background-color:var(--background-color);border-radius:var(--border-radius);overflow:hidden;margin-bottom:15px;box-shadow:var(--shadow)}.nft-image{width:100%;height:auto;display:flex;justify-content:center;align-items:center}.nft-image svg{max-width:100%;height:auto}.nft-info h3{color:var(--text-color);margin-bottom:10px}.nft-info p{color:var(--text-light)}.auction-info{display:flex;flex-direction:column;justify-content:space-between}.auction-status{background-color:var(--background-color);padding:15px;border-radius:var(--border-radius);margin-bottom:20px}.auction-status p{margin-bottom:10px}.auction-status span{font-weight:600;color:var(--primary-color)}.bid-form{display:flex;gap:10px}.bid-form input{flex:1;padding:10px 15px;border:1px solid var(--border-color);border-radius:var(--border-radius);font-size:1rem}.voting-container{background-color:var(--card-background);border-radius:var(--border-radius)}.voting-tabs{display:flex;border-bottom:1px solid var(--border-color);margin-bottom:20px}.tab-btn{padding:10px 20px;background:0 0;border:none;cursor:pointer;font-weight:600;color:var(--text-light);position:relative}.tab-btn.active{color:var(--primary-color)}.tab-btn.active::after{content:'';position:absolute;bottom:-1px;left:0;width:100%;height:3px;background-color:var(--primary-color)}.tab-content{padding:10px}.vote-list{display:flex;flex-direction:column;gap:20px}.vote-item{background-color:var(--background-color);border-radius:var(--border-radius);padding:20px;box-shadow:0 2px 4px rgba(0,0,0,.05)}.vote-item h3{margin-bottom:15px;color:var(--text-color)}.vote-options{margin-bottom:20px}.vote-option{margin-bottom:10px}.vote-option label{display:flex;align-items:center;margin-bottom:5px;cursor:pointer}.vote-option input[type=radio]{margin-right:10px}.vote-progress{height:10px;background-color:var(--border-color);border-radius:5px;margin-top:5px;position:relative;overflow:hidden}.progress-bar{height:100%;background-color:var(--primary-color);border-radius:5px}.vote-progress span{position:absolute;right:5px;top:-18px;font-size:.8rem;color:var(--text-light)}.vote-result{background-color:rgba(108,92,231,.1);padding:10px;border-radius:var(--border-radius);margin-top:10px}.vote-result p{margin-bottom:5px;font-size:.9rem}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600}.form-group input{width:100%;padding:10px 15px;border:1px solid var(--border-color);border-radius:var(--border-radius);font-size:1rem}#vote-options-container{margin-bottom:10px}.vote-option-input{display:flex;gap:10px;margin-bottom:10px}.remove-option{background-color:var(--error-color);color:#fff;border:none;border-radius:var(--border-radius);padding:5px 10px;cursor:pointer}footer{background-color:var(--card-background);padding:20px;text-align:center;margin-top:30px;box-shadow:0 -2px 10px rgba(0,0,0,.05)}.network-info{display:flex;justify-content:center;gap:20px;margin-top:10px;font-size:.9rem;color:var(--text-light)}.notification{position:fixed;bottom:20px;right:20px;padding:15px 25px;background-color:var(--primary-color);color:#fff;border-radius:var(--border-radius);box-shadow:var(--shadow);z-index:1000;transition:all .3s ease;transform:translateY(100px);opacity:0}.notification.show{transform:translateY(0);opacity:1}.notification.success{background-color:var(--success-color)}.notification.error{background-color:var(--error-color)}.notification.warning{background-color:var(--warning-color);color:var(--text-color)}@media (max-width:768px){.auction-container{grid-template-columns:1fr}.wallet-container{flex-direction:column;align-items:flex-start}#wallet-info{margin-top:10px;flex-direction:column;gap:10px}.bid-form{flex-direction:column}.voting-tabs{overflow-x:auto;white-space:nowrap}}
    </style>
</head>
<body>
    <header>
        <h1>フルオンチェーンNFTオークション＆投票サービス</h1>
        <div class="wallet-container">
            <button id="connect-wallet" class="btn">ウォレット接続</button>
            <div id="wallet-info" class="hidden">
                <span id="wallet-address">未接続</span>
                <span id="wallet-balance">0 ETH</span>
            </div>
        </div>
    </header>

    <main>
        <section id="auction-section" class="section">
            <h2>本日のオークション</h2>
            <div class="auction-container">
                <div class="nft-preview">
                    <div class="nft-image-container">
                        <div class="nft-image" id="current-nft">
                            <!-- NFTのSVG画像がここに表示されます -->
                            <svg width="300" height="300" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                                <rect width="300" height="300" fill="#f0f0f0" />
                                <text x="150" y="150" font-family="Arial" font-size="24" text-anchor="middle" fill="#333">NFT #1</text>
                                <circle cx="150" cy="150" r="100" fill="none" stroke="#333" stroke-width="2" />
                            </svg>
                        </div>
                    </div>
                    <div class="nft-info">
                        <h3 id="nft-title">NFT #1</h3>
                        <p id="nft-description">今日のユニークNFT</p>
                    </div>
                </div>
                <div class="auction-info">
                    <div class="auction-status">
                        <p>現在の最高入札額: <span id="highest-bid">0.1 ETH</span></p>
                        <p>最高入札者: <span id="highest-bidder">0x1234...5678</span></p>
                        <p>オークション終了まで: <span id="auction-time-left">12:34:56</span></p>
                    </div>
                    <div class="bid-form">
                        <input type="number" id="bid-amount" min="0.01" step="0.01" placeholder="入札額（ETH）">
                        <button id="place-bid" class="btn">入札する</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="voting-section" class="section">
            <h2>投票システム</h2>
            <div class="voting-container">
                <div class="voting-tabs">
                    <button class="tab-btn active" data-tab="active-votes">進行中の投票</button>
                    <button class="tab-btn" data-tab="past-votes">過去の投票</button>
                    <button class="tab-btn" data-tab="create-vote">新規投票作成</button>
                </div>
                
                <div class="tab-content" id="active-votes">
                    <div class="vote-list">
                        <!-- 進行中の投票リスト（動的に生成） -->
                    </div>
                </div>
                
                <div class="tab-content hidden" id="past-votes">
                    <div class="vote-list">
                        <!-- 過去の投票リスト（動的に生成） -->
                    </div>
                </div>
                
                <div class="tab-content hidden" id="create-vote">
                    <form id="new-vote-form">
                        <div class="form-group">
                            <label for="vote-title">投票タイトル</label>
                            <input type="text" id="vote-title" required placeholder="例: 次回のNFTテーマは？">
                        </div>
                        <div class="form-group">
                            <label>選択肢</label>
                            <div id="vote-options-container">
                                <div class="vote-option-input">
                                    <input type="text" class="vote-option-text" required placeholder="選択肢1">
                                    <button type="button" class="remove-option">削除</button>
                                </div>
                                <div class="vote-option-input">
                                    <input type="text" class="vote-option-text" required placeholder="選択肢2">
                                    <button type="button" class="remove-option">削除</button>
                                </div>
                            </div>
                            <button type="button" id="add-option" class="btn-secondary">選択肢を追加</button>
                        </div>
                        <div class="form-group">
                            <label for="vote-duration">投票期間（日）</label>
                            <input type="number" id="vote-duration" min="1" max="30" value="7" required>
                        </div>
                        <button type="submit" class="btn">投票を作成</button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 フルオンチェーンNFTオークション＆投票サービス</p>
        <div class="network-info">
            <span id="network-name">ネットワーク: 未接続</span>
            <span id="gas-price">ガス価格: -- Gwei</span>
        </div>
    </footer>

    <div id="notification" class="notification hidden"></div>

    <script>
        // コントラクトアドレス（デプロイ後に更新されます）
        const CONTRACT_ADDRESSES = {
            nft: "YOUR_NFT_CONTRACT_ADDRESS",
            auction: "YOUR_AUCTION_CONTRACT_ADDRESS",
            voting: "YOUR_VOTING_CONTRACT_ADDRESS",
            webAppStorage: "YOUR_WEBAPP_STORAGE_CONTRACT_ADDRESS"
        };
        
        // コントラクトABI
        const NFT_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function ownerOf(uint256 tokenId) view returns (address)",
            "function balanceOf(address owner) view returns (uint256)"
        ];
        
        const AUCTION_ABI = [
            "function getActiveAuction() view returns (tuple(uint256 tokenId, uint256 startingPrice, uint256 highestBid, address highestBidder, uint256 endTime, bool ended, bool claimed))",
            "function getAuction(uint256 auctionId) view returns (tuple(uint256 tokenId, uint256 startingPrice, uint256 highestBid, address highestBidder, uint256 endTime, bool ended, bool claimed))",
            "function placeBid(uint256 auctionId) payable",
            "function getRemainingTime(uint256 auctionId) view returns (uint256)",
            "function getNextMinimumBid(uint256 auctionId) view returns (uint256)",
            "function getPendingReturns(address bidder) view returns (uint256)",
            "function withdrawFunds() returns (bool)",
            "function claimNFT(uint256 auctionId)"
        ];
        
        const VOTING_ABI = [
            "function getProposalCount() view returns (uint256)",
            "function getProposalDetails(uint256 proposalId) view returns (tuple(uint256 id, string title, string description, address proposer, uint256 startTime, uint256 endTime, bool executed, uint256 forVotes, uint256 againstVotes))",
            "function createProposal(string title, string description, uint256 duration)",
            "function castVote(uint256 proposalId, bool support)",
            "function getVoteInfo(uint256 proposalId, address voter) view returns (bool hasVoted, bool support)",
            "function isProposalActive(uint256 proposalId) view returns (bool)",
            "function isProposalEnded(uint256 proposalId) view returns (bool)",
            "function isProposalPassed(uint256 proposalId) view returns (bool)",
            "function getRemainingTime(uint256 proposalId) view returns (uint256)",
            "function getVotingWeight(address voter) view returns (uint256)"
        ];
        
        // モックデータ（コントラクト接続前に使用）
        const mockData = {
            currentNFT: {
                id: 1,
                title: "NFT #1",
                description: "今日のユニークNFT",
                image: `<svg width="300" height="300" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                            <rect width="300" height="300" fill="#f0f0f0" />
                            <text x="150" y="150" font-family="Arial" font-size="24" text-anchor="middle" fill="#333">NFT #1</text>
                            <circle cx="150" cy="150" r="100" fill="none" stroke="#333" stroke-width="2" />
                        </svg>`
            },
            auction: {
                highestBid: "0.1",
                highestBidder: "0x1234...5678",
                endTime: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24時間後
            },
            activeVotes: [
                {
                    id: 1,
                    title: "次回のNFTテーマは？",
                    options: [
                        { id: 1, text: "宇宙", votes: 65 },
                        { id: 2, text: "海洋", votes: 35 }
                    ],
                    totalVotes: 100,
                    endTime: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000) // 3日後
                }
            ],
            pastVotes: [
                {
                    id: 2,
                    title: "トレジャリー資金の使途は？",
                    options: [
                        { id: 1, text: "開発者報酬", votes: 45 },
                        { id: 2, text: "マーケティング", votes: 30 },
                        { id: 3, text: "流動性提供", votes: 25 }
                    ],
                    totalVotes: 100,
                    endTime: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5日前
                    result: "開発者報酬に決定"
                }
            ]
        };

        // Web3関連の状態
        let web3State = {
            isConnected: false,
            account: null,
            balance: 0,
            network: null,
            gasPrice: null,
            provider: null
        };

        // DOM要素
        const connectWalletBtn = document.getElementById('connect-wallet');
        const walletInfo = document.getElementById('wallet-info');
        const walletAddress = document.getElementById('wallet-address');
        const walletBalance = document.getElementById('wallet-balance');
        const networkName = document.getElementById('network-name');
        const gasPrice = document.getElementById('gas-price');
        const placeBidBtn = document.getElementById('place-bid');
        const bidAmountInput = document.getElementById('bid-amount');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const newVoteForm = document.getElementById('new-vote-form');
        const addOptionBtn = document.getElementById('add-option');
        const voteOptionsContainer = document.getElementById('vote-options-container');
        const currentNftElement = document.getElementById('current-nft');
        const nftTitleElement = document.getElementById('nft-title');
        const nftDescriptionElement = document.getElementById('nft-description');

        // 通知関連
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // コントラクトインスタンス
        let nftContract;
        let auctionContract;
        let votingContract;
        let provider;
        let signer;

        // ウォレット接続処理
        async function connectWallet() {
            try {
                // MetaMaskが利用可能か確認
                if (window.ethereum) {
                    // プロバイダーとシグナーを設定
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    
                    // ウォレット接続を要求
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    
                    // アカウント情報を取得
                    web3State.account = await signer.getAddress();
                    web3State.balance = ethers.utils.formatEther(await provider.getBalance(web3State.account));
                    
                    // ネットワーク情報を取得
                    const network = await provider.getNetwork();
                    web3State.network = network.name === 'arbitrum' ? 'Arbitrum' : network.name;
                    
                    // ガス価格を取得
                    const gasPrice = await provider.getGasPrice();
                    web3State.gasPrice = (parseFloat(ethers.utils.formatUnits(gasPrice, 'gwei'))).toFixed(2);
                    
                    // コントラクトインスタンスを初期化
                    initContracts();
                    
                    // 接続状態を更新
                    web3State.isConnected = true;
                    
                    // UI更新
                    updateWalletUI();
                    
                    // データ更新
                    await updateAuctionData();
                    await updateVotingData();
                    
                    showNotification('ウォレットが接続されました', 'success');
                    return true;
                } else {
                    showNotification('MetaMaskをインストールしてください', 'warning');
                    return false;
                }
            } catch (error) {
                console.error('ウォレット接続エラー:', error);
                showNotification('ウォレット接続に失敗しました', 'error');
                return false;
            }
        }
        
        // コントラクトの初期化
        function initContracts() {
            try {
                nftContract = new ethers.Contract(CONTRACT_ADDRESSES.nft, NFT_ABI, provider);
                auctionContract = new ethers.Contract(CONTRACT_ADDRESSES.auction, AUCTION_ABI, provider);
                votingContract = new ethers.Contract(CONTRACT_ADDRESSES.voting, VOTING_ABI, provider);
                
                // 署名付きコントラクト（トランザクション送信用）
                nftContractWithSigner = nftContract.connect(signer);
                auctionContractWithSigner = auctionContract.connect(signer);
                votingContractWithSigner = votingContract.connect(signer);
            } catch (error) {
                console.error('コントラクト初期化エラー:', error);
                showNotification('コントラクトの初期化に失敗しました', 'error');
            }
        }

        // ウォレットUI更新
        function updateWalletUI() {
            if (web3State.isConnected) {
                connectWalletBtn.textContent = '接続済み';
                connectWalletBtn.disabled = true;
                walletInfo.classList.remove('hidden');
                
                // アドレスを省略表示
                const shortAddress = `${web3State.account.substring(0, 6)}...${web3State.account.substring(38)}`;
                walletAddress.textContent = shortAddress;
                walletBalance.textContent = `${web3State.balance} ETH`;
                
                // ネットワーク情報
                networkName.textContent = `ネットワーク: ${web3State.network}`;
                gasPrice.textContent = `ガス価格: ${web3State.gasPrice} Gwei`;
            } else {
                connectWalletBtn.textContent = 'ウォレット接続';
                connectWalletBtn.disabled = false;
                walletInfo.classList.add('hidden');
                networkName.textContent = 'ネットワーク: 未接続';
                gasPrice.textContent = 'ガス価格: -- Gwei';
            }
        }

        // オークションデータの更新
        async function updateAuctionData() {
            if (!web3State.isConnected || !auctionContract) return;
            
            try {
                // アクティブなオークション情報を取得
                const activeAuction = await auctionContract.getActiveAuction();
                const auctionId = activeAuction.tokenId.toNumber();
                
                // オークション情報を更新
                mockData.auction.highestBid = ethers.utils.formatEther(activeAuction.highestBid);
                mockData.auction.highestBidder = activeAuction.highestBidder === ethers.constants.AddressZero ? 
                    "まだ入札はありません" : 
                    `${activeAuction.highestBidder.substring(0, 6)}...${activeAuction.highestBidder.substring(38)}`;
                
                // 残り時間を計算
                const remainingTime = await auctionContract.getRemainingTime(auctionId);
                const endTimeMs = Date.now() + remainingTime.toNumber() * 1000;
                mockData.auction.endTime = new Date(endTimeMs);
                
                // UI更新
                document.getElementById('highest-bid').textContent = `${mockData.auction.highestBid} ETH`;
                document.getElementById('highest-bidder').textContent = mockData.auction.highestBidder;
                
                // NFT情報を取得
                if (nftContract) {
                    try {
                        const tokenURI = await nftContract.tokenURI(auctionId);
                        // Base64エンコードされたJSONデータを取得
                        if (tokenURI.startsWith('data:application/json;base64,')) {
                            const base64Data = tokenURI.replace('data:application/json;base64,', '');
                            const jsonData = JSON.parse(atob(base64Data));
                            
                            // NFT情報を更新
                            mockData.currentNFT.id = auctionId;
                            mockData.currentNFT.title = jsonData.name || `NFT #${auctionId}`;
                            mockData.currentNFT.description = jsonData.description || "フルオンチェーンNFTオークションで作成されたNFT";
                            
                            // SVG画像を取得
                            if (jsonData.image && jsonData.image.startsWith('data:image/svg+xml;base64,')) {
                                const svgBase64 = jsonData.image.replace('data:image/svg+xml;base64,', '');
                                mockData.currentNFT.image = atob(svgBase64);
                            }
                            
                            // UI更新
                            updateNFTDisplay();
                        }
                    } catch (error) {
                        console.error('NFT情報取得エラー:', error);
                    }
                }
            } catch (error) {
                console.error('オークションデータ更新エラー:', error);
            }
        }
        
        // 投票データの更新
        async function updateVotingData() {
            if (!web3State.isConnected || !votingContract) return;
            
            try {
                // 提案の総数を取得
                const proposalCount = await votingContract.getProposalCount();
                
                // アクティブな投票と過去の投票をリセット
                mockData.activeVotes = [];
                mockData.pastVotes = [];
                
                // 各提案の詳細を取得
                for (let i = 1; i <= proposalCount.toNumber(); i++) {
                    const proposal = await votingContract.getProposalDetails(i);
                    const isActive = await votingContract.isProposalActive(i);
                    const isPassed = await votingContract.isProposalPassed(i);
                    
                    // 提案情報を作成
                    const voteInfo = {
                        id: proposal.id.toNumber(),
                        title: proposal.title,
                        options: [
                            { id: 1, text: "賛成", votes: proposal.forVotes.toNumber() },
                            { id: 2, text: "反対", votes: proposal.againstVotes.toNumber() }
                        ],
                        totalVotes: proposal.forVotes.toNumber() + proposal.againstVotes.toNumber(),
                        endTime: new Date(proposal.endTime.toNumber() * 1000)
                    };
                    
                    // アクティブな投票か過去の投票かを判断
                    if (isActive) {
                        mockData.activeVotes.push(voteInfo);
                    } else {
                        voteInfo.result = isPassed ? "提案が可決されました" : "提案が否決されました";
                        mockData.pastVotes.push(voteInfo);
                    }
                }
                
                // UI更新
                updateVotesList();
            } catch (error) {
                console.error('投票データ更新エラー:', error);
            }
        }

        // オークション入札処理
        async function placeBid(amount) {
            if (!web3State.isConnected) {
                showNotification('入札するにはウォレットを接続してください', 'warning');
                return false;
            }
            
            if (!auctionContractWithSigner) {
                showNotification('コントラクトが初期化されていません', 'error');
                return false;
            }
            
            try {
                // アクティブなオークション情報を取得
                const activeAuction = await auctionContract.getActiveAuction();
                const auctionId = activeAuction.tokenId.toNumber();
                
                // 最小入札額を確認
                const nextMinBid = await auctionContract.getNextMinimumBid(auctionId);
                const amountInWei = ethers.utils.parseEther(amount);
                
                if (amountInWei.lt(nextMinBid)) {
                    showNotification(`最小入札額は ${ethers.utils.formatEther(nextMinBid)} ETH です`, 'warning');
                    return false;
                }
                
                // 入札トランザクションを送信
                const tx = await auctionContractWithSigner.placeBid(auctionId, {
                    value: amountInWei
                });
                
                // トランザクションの完了を待機
                showNotification('入札トランザクションを送信しました。確認中...', 'info');
                await tx.wait();
                
                // データを更新
                await updateAuctionData();
                
                showNotification('入札が成功しました', 'success');
                return true;
            } catch (error) {
                console.error('入札エラー:', error);
                
                // エラーメッセージを解析
                let errorMessage = '入札に失敗しました';
                if (error.message.includes('入札額が最小入札価格を下回っています')) {
                    errorMessage = '入札額が最小入札価格を下回っています';
                } else if (error.message.includes('入札額が開始価格を下回っています')) {
                    errorMessage = '入札額が開始価格を下回っています';
                } else if (error.message.includes('入札額が最小入札増加率を満たしていません')) {
                    errorMessage = '入札額が最小入札増加率を満たしていません';
                } else if (error.message.includes('オークション期間が終了しています')) {
                    errorMessage = 'オークション期間が終了しています';
                }
                
                showNotification(errorMessage, 'error');
                return false;
            }
        }

        // 投票処理
        async function submitVote(voteId, optionId) {
            if (!web3State.isConnected) {
                showNotification('投票するにはウォレットを接続してください', 'warning');
                return false;
            }
            
            if (!votingContractWithSigner) {
                showNotification('コントラクトが初期化されていません', 'error');
                return false;
            }
            
            try {
                // 提案が有効かチェック
                const isActive = await votingContract.isProposalActive(voteId);
                if (!isActive) {
                    showNotification('この提案はすでに終了しています', 'warning');
                    return false;
                }
                
                // 投票情報を取得
                const [hasVoted, _] = await votingContract.getVoteInfo(voteId, web3State.account);
                if (hasVoted) {
                    showNotification('すでに投票済みです', 'warning');
                    return false;
                }
                
                // 投票トランザクションを送信
                const support = optionId === "1"; // 1が賛成、2が反対
                const tx = await votingContractWithSigner.castVote(voteId, support);
                
                // トランザクションの完了を待機
                showNotification('投票トランザクションを送信しました。確認中...', 'info');
                await tx.wait();
                
                // データを更新
                await updateVotingData();
                
                showNotification('投票が成功しました', 'success');
                return true;
            } catch (error) {
                console.error('投票エラー:', error);
                
                // エラーメッセージを解析
                let errorMessage = '投票に失敗しました';
                if (error.message.includes('NFTホルダーのみが投票できます')) {
                    errorMessage = 'NFTホルダーのみが投票できます';
                } else if (error.message.includes('投票期間が終了しています')) {
                    errorMessage = '投票期間が終了しています';
                } else if (error.message.includes('既に投票しています')) {
                    errorMessage = 'すでに投票済みです';
                }
                
                showNotification(errorMessage, 'error');
                return false;
            }
        }

        // 新規投票作成
        async function createVote(title, options, duration) {
            if (!web3State.isConnected) {
                showNotification('投票を作成するにはウォレットを接続してください', 'warning');
                return false;
            }
            
            if (!votingContractWithSigner) {
                showNotification('コントラクトが初期化されていません', 'error');
                return false;
            }
            
            try {
                // NFTホルダーかチェック
                const votingWeight = await votingContract.getVotingWeight(web3State.account);
                if (votingWeight.toNumber() === 0) {
                    showNotification('NFTホルダーのみが提案を作成できます', 'warning');
                    return false;
                }
                
                // 提案作成トランザクションを送信
                const durationInSeconds = duration * 24 * 60 * 60; // 日数を秒に変換
                const description = options.join(" / "); // 選択肢を説明に含める
                
                const tx = await votingContractWithSigner.createProposal(title, description, durationInSeconds);
                
                // トランザクションの完了を待機
                showNotification('提案作成トランザクションを送信しました。確認中...', 'info');
                await tx.wait();
                
                // データを更新
                await updateVotingData();
                
                showNotification('提案が作成されました', 'success');
                return true;
            } catch (error) {
                console.error('提案作成エラー:', error);
                
                // エラーメッセージを解析
                let errorMessage = '提案の作成に失敗しました';
                if (error.message.includes('NFTホルダーのみが提案を作成できます')) {
                    errorMessage = 'NFTホルダーのみが提案を作成できます';
                } else if (error.message.includes('提案期間が制限外です')) {
                    errorMessage = '提案期間が制限外です';
                }
                
                showNotification(errorMessage, 'error');
                return false;
            }
        }

        // NFT表示の更新
        function updateNFTDisplay() {
            const nft = mockData.currentNFT;
            currentNftElement.innerHTML = nft.image;
            nftTitleElement.textContent = nft.title;
            nftDescriptionElement.textContent = nft.description;
        }

        // 入札処理
        async function handleBid() {
            const amount = bidAmountInput.value;
            
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                showNotification('有効な入札額を入力してください', 'warning');
                return;
            }
            
            const success = await placeBid(amount);
            
            if (success) {
                bidAmountInput.value = '';
            }
        }

        // タブ切り替え
        function switchTab(tabId) {
            // タブボタンのアクティブ状態を更新
            tabButtons.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // タブコンテンツの表示/非表示を切り替え
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        }

        // 投票フォームに選択肢を追加
        function addVoteOption() {
            const optionCount = voteOptionsContainer.children.length + 1;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'vote-option-input';
            
            optionDiv.innerHTML = `
                <input type="text" class="vote-option-text" required placeholder="選択肢${optionCount}">
                <button type="button" class="remove-option">削除</button>
            `;
            
            voteOptionsContainer.appendChild(optionDiv);
        }

        // 投票フォームから選択肢を削除
        function removeVoteOption(button) {
            const optionDiv = button.parentElement;
            
            // 最低2つの選択肢は必要
            if (voteOptionsContainer.children.length > 2) {
                voteOptionsContainer.removeChild(optionDiv);
            } else {
                showNotification('最低2つの選択肢が必要です', 'warning');
            }
        }

        // 投票フォーム送信処理
        async function handleVoteSubmit(e) {
            e.preventDefault();
            
            const title = document.getElementById('vote-title').value;
            const duration = document.getElementById('vote-duration').value;
            const optionInputs = document.querySelectorAll('.vote-option-text');
            
            const options = Array.from(optionInputs).map(input => input.value);
            
            if (!web3State.isConnected) {
                showNotification('投票を作成するにはウォレットを接続してください', 'warning');
                return;
            }
            
            const success = await createVote(title, options, duration);
            
            if (success) {
                // フォームをリセット
                newVoteForm.reset();
                
                // 選択肢を2つだけにリセット
                while (voteOptionsContainer.children.length > 2) {
                    voteOptionsContainer.removeChild(voteOptionsContainer.lastChild);
                }
                
                // アクティブな投票タブに切り替え
                switchTab('active-votes');
            }
        }

        // 投票送信処理
        async function handleVoteSubmission(voteId, optionId) {
            if (!web3State.isConnected) {
                showNotification('投票するにはウォレットを接続してください', 'warning');
                return;
            }
            
            const success = await submitVote(voteId, optionId);
            
            if (success) {
                // 投票後のUI更新
                // 実際の実装ではブロックチェーンから最新の投票状況を取得
            }
        }

        // 動的に投票アイテムを生成
        function createVoteItem(vote, isPast = false) {
            const voteItem = document.createElement('div');
            voteItem.className = `vote-item ${isPast ? 'completed' : ''}`;
            voteItem.setAttribute('data-vote-id', vote.id);
            
            let optionsHTML = '';
            
            vote.options.forEach(option => {
                const percentage = vote.totalVotes > 0 ? Math.round((option.votes / vote.totalVotes) * 100) : 0;
                
                if (isPast) {
                    optionsHTML += `
                        <div class="vote-option">
                            <span>${option.text}</span>
                            <div class="vote-progress">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                                <span>${percentage}%</span>
                            </div>
                        </div>
                    `;
                } else {
                    optionsHTML += `
                        <div class="vote-option">
                            <label>
                                <input type="radio" name="vote-${vote.id}" value="${option.id}">
                                <span>${option.text}</span>
                            </label>
                            <div class="vote-progress">
                                <div class="progress-bar" style="width: ${percentage}%"></div>
                                <span>${percentage}%</span>
                            </div>
                        </div>
                    `;
                }
            });
            
            let resultHTML = '';
            if (isPast && vote.result) {
                const endDate = new Date(vote.endTime).toLocaleDateString('ja-JP');
                resultHTML = `
                    <div class="vote-result">
                        <p>結果: ${vote.result}</p>
                        <p>投票終了: ${endDate}</p>
                    </div>
                `;
            }
            
            const submitButtonHTML = isPast ? '' : '<button class="btn vote-submit">投票する</button>';
            
            voteItem.innerHTML = `
                <h3>${vote.title}</h3>
                <div class="vote-options">
                    ${optionsHTML}
                </div>
                ${resultHTML}
                ${submitButtonHTML}
            `;
            
            // 投票ボタンのイベントリスナーを追加
            if (!isPast) {
                const submitBtn = voteItem.querySelector('.vote-submit');
                if (submitBtn) {
                    submitBtn.addEventListener('click', function() {
                        const selectedOption = voteItem.querySelector('input[type="radio"]:checked');
                        
                        if (selectedOption) {
                            handleVoteSubmission(vote.id, selectedOption.value);
                        } else {
                            showNotification('選択肢を選んでください', 'warning');
                        }
                    });
                }
            }
            
            return voteItem;
        }

        // 投票リストの更新
        function updateVotesList() {
            const activeVotesContainer = document.querySelector('#active-votes .vote-list');
            const pastVotesContainer = document.querySelector('#past-votes .vote-list');
            
            // 進行中の投票リストをクリア
            activeVotesContainer.innerHTML = '';
            
            // 過去の投票リストをクリア
            pastVotesContainer.innerHTML = '';
            
            // 進行中の投票を追加
            mockData.activeVotes.forEach(vote => {
                const voteItem = createVoteItem(vote);
                activeVotesContainer.appendChild(voteItem);
            });
            
            // 過去の投票を追加
            mockData.pastVotes.forEach(vote => {
                const voteItem = createVoteItem(vote, true);
                pastVotesContainer.appendChild(voteItem);
            });
        }

        // オークション残り時間の更新
        function updateAuctionTimeLeft() {
            const timeLeftElement = document.getElementById('auction-time-left');
            const endTime = mockData.auction.endTime;
            const now = new Date();
            
            if (endTime > now) {
                const diff = endTime - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                timeLeftElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                timeLeftElement.textContent = '終了';
            }
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            // ウォレット接続ボタンのイベントリスナー
            connectWalletBtn.addEventListener('click', connectWallet);
            
            // 入札ボタンのイベントリスナー
            placeBidBtn.addEventListener('click', handleBid);
            
            // タブ切り替えのイベントリスナー
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // 投票フォームの選択肢追加ボタン
            addOptionBtn.addEventListener('click', addVoteOption);
            
            // 投票フォームの送信
            newVoteForm.addEventListener('submit', handleVoteSubmit);
            
            // 選択肢削除ボタンのイベントリスナー
            document.addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('remove-option')) {
                    removeVoteOption(e.target);
                }
            });
        }

        // 初期化
        function init() {
            setupEventListeners();
            updateNFTDisplay();
            updateVotesList();
            
            // オークション残り時間の定期更新
            setInterval(updateAuctionTimeLeft, 1000);
            
            // ethers.jsが利用可能か確認
            if (window.ethereum) {
                // プロバイダーを初期化
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // アカウント変更イベントをリッスン
                window.ethereum.on('accountsChanged', async (accounts) => {
                    if (accounts.length === 0) {
                        // ウォレット接続解除
                        web3State.isConnected = false;
                        web3State.account = null;
                        updateWalletUI();
                    } else {
                        // 再接続
                        await connectWallet();
                    }
                });
                
                // ネットワーク変更イベントをリッスン
                window.ethereum.on('chainChanged', () => {
                    // ページをリロード
                    window.location.reload();
                });
            }
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', init);
    </script>
